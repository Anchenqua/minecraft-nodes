name: 项目构建（Notes，Ports，Dynmap）

on:
  workflow_dispatch:

jobs:
  BuildNotes:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4


      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'


      - name: Change Permission
        run:
          sudo chmod -R 777 /home/runner


      - name: Build Nodes
        run: |
          cd nodes
          ./gradlew build


      - name: Upload Releases
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./nodes/build/libs/nodes-1.21.1.jar
          asset_name: nodes-1.21.1.jar
          
  BuildDynmap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4


      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20


      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          profile: minimal
          override: true
          components: rustfmt, clippy


      - name: npm install
        run: |
          cd dynmap
          npm install


      - name: Handle wasm
        run: |
          cd dynmap
          rustup target add wasm32-unknown-unknown
          cargo install -f --version 0.2.100 wasm-bindgen-cli
          npm run wasm


      - name: Build Dynmap
        run: |
          cd dynmap
          npm run build


      - name: Zip Dynmap
        run: |
          zip -r Dynmap.zip ./dynmap/build


      - name: Upload Releases
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./Dynmap.zip
          asset_name: Dynmap.zip


  BuildPorts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4


      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'


      - name: Change Permission
        run: |
          sudo chmod -R 777 /home/runner

        
      - name: build ports
        run: |
          cd ports
          ./gradlew build


      - name: Upload Releases
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./ports/build/libs/nodes-ports-*.jar
          asset_name: nodes-ports-1.21.1.jar
